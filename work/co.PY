import cv2
import numpy as np
import mss
import pygetwindow as gw
import time

# ==========================================
# 1. é€™è£¡å¡«å…¥ä½ æƒ³æª¢æŸ¥çš„åº§æ¨™
# ==========================================
GAME_TITLE = "ToramOnline"

# ä½ å‰›å‰›æä¾›çš„åº§æ¨™
CHECK_REGIONS = {
    "AMOUNT_REGION": {"top": 200, "left": 477, "width": 28, "height": 45},
    "PRICE_REGION":  {"top": 200, "left": 980, "width": 220, "height": 45}
}

# ==========================================
# 2. åŸ·è¡Œæª¢æŸ¥
# ==========================================
def draw_debug_boxes():
    print("â³ å°‹æ‰¾éŠæˆ²è¦–çª—ä¸­...")
    try:
        # å–å¾—éŠæˆ²è¦–çª—
        windows = gw.getWindowsWithTitle(GAME_TITLE)
        if not windows:
            print(f"âŒ æ‰¾ä¸åˆ° '{GAME_TITLE}'ï¼Œè«‹å…ˆé–‹å•ŸéŠæˆ²ã€‚")
            return
        
        window = windows[0]
        if not window.isActive:
            window.activate()
            time.sleep(1) # ç­‰å¾…è¦–çª—å½ˆå‡º

        print(f"âœ… é–å®šè¦–çª—: {window.title} ({window.width}x{window.height})")
        
        with mss.mss() as sct:
            # æˆªå–æ•´å€‹éŠæˆ²è¦–çª—
            monitor = {
                "top": window.top, 
                "left": window.left, 
                "width": window.width, 
                "height": window.height
            }
            img = np.array(sct.grab(monitor))
            
            # è½‰æ›é¡è‰² (MSS æ˜¯ BGRAï¼ŒOpenCV éœ€è¦ BGR)
            img = cv2.cvtColor(img, cv2.COLOR_BGRA2BGR)

            # é–‹å§‹ç•«æ¡†æ¡†
            for name, r in CHECK_REGIONS.items():
                x = r["left"]
                y = r["top"]
                w = r["width"]
                h = r["height"]
                
                # è¨­å®šé¡è‰²
                if "PRICE" in name:
                    color = (0, 0, 255) # ç´…è‰² (åƒ¹æ ¼)
                else:
                    color = (255, 0, 0) # è—è‰² (æ•¸é‡)

                # ç•«çŸ©å½¢
                cv2.rectangle(img, (x, y), (x + w, y + h), color, 2)
                
                # å¯«ä¸Šæ¨™ç±¤æ–‡å­—
                cv2.putText(img, name, (x, y - 5), 
                            cv2.FONT_HERSHEY_SIMPLEX, 0.5, color, 2)

            # å­˜æª”
            filename = "check_range.png"
            cv2.imwrite(filename, img)
            print(f"ğŸ“¸ æˆªåœ–å·²å„²å­˜ç‚º: {filename}")
            print("è«‹æ‰“é–‹é€™å¼µåœ–ç‰‡ï¼Œç¢ºèªæ¡†æ¡†æ˜¯å¦å‰›å¥½åŒ…ä½æ•¸å­—ï¼")
            
            # ç›´æ¥å½ˆå‡ºè¦–çª—é¡¯ç¤º (æŒ‰ä»»æ„éµé—œé–‰)
            cv2.imshow("Debug View", img)
            cv2.waitKey(0)
            cv2.destroyAllWindows()

    except Exception as e:
        print(f"âŒ ç™¼ç”ŸéŒ¯èª¤: {e}")

if __name__ == "__main__":
    draw_debug_boxes()